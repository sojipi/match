# Gemini API Key ç”¨æˆ·è‡ªå®šä¹‰åŠŸèƒ½ - å®ç°æ€»ç»“

## âœ… åŠŸèƒ½å·²å®Œæˆ

### ğŸ¯ åŠŸèƒ½ç›®æ ‡
å½“ç³»ç»Ÿçš„ Gemini API é…é¢è¾¾åˆ°é™åˆ¶æ—¶ï¼Œå¼¹çª—æé†’ç”¨æˆ·ï¼Œå¹¶å¼•å¯¼ç”¨æˆ·é…ç½®è‡ªå·±çš„ Gemini API Keyï¼Œä»è€Œé¿å…é…é¢é™åˆ¶ï¼Œäº«å—ä¸é—´æ–­çš„ AI å¯¹è¯æœåŠ¡ã€‚

---

## ğŸ“‹ å®ç°æ¸…å•

### âœ… åç«¯å®ç°

#### 1. æ•°æ®åº“æ›´æ”¹
- **è¡¨**: `users`
- **æ–°å­—æ®µ**: `gemini_api_key VARCHAR(255)`
- **çŠ¶æ€**: âœ… å·²è¿ç§»æˆåŠŸ

```sql
ALTER TABLE users ADD COLUMN gemini_api_key VARCHAR(255);
```

#### 2. ç”¨æˆ·æ¨¡å‹æ›´æ–°
- **æ–‡ä»¶**: `backend/app/models/user.py`
- **æ›´æ”¹**: æ·»åŠ  `gemini_api_key` å­—æ®µ
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### 3. API ç«¯ç‚¹
- **æ–‡ä»¶**: `backend/app/api/v1/endpoints/user_settings.py`
- **ç«¯ç‚¹**:
  - `GET /api/v1/users/settings` - è·å–ç”¨æˆ·è®¾ç½®ï¼ˆAPI Key å·²è„±æ•ï¼‰
  - `PUT /api/v1/users/settings` - æ›´æ–°ç”¨æˆ·è®¾ç½®
- **çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æ³¨å†Œåˆ°è·¯ç”±

#### 4. AI ä»£ç†æœåŠ¡æ›´æ–°
- **æ–‡ä»¶**: `backend/app/services/ai_agent_service.py`
- **æ›´æ”¹**:
  - `UserAvatarAgent` æ¥å— `user_api_key` å‚æ•°
  - ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·çš„ API Keyï¼Œå¦åˆ™ä½¿ç”¨ç³»ç»Ÿ Key
  - æ£€æµ‹ 429 é…é¢é”™è¯¯å¹¶æŠ›å‡ºç‰¹å®šå¼‚å¸¸
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### 5. WebSocket é”™è¯¯å¤„ç†
- **æ–‡ä»¶**: `backend/app/websocket/manager.py`
- **æ›´æ”¹**:
  - æ•è· `GEMINI_QUOTA_EXCEEDED` å¼‚å¸¸
  - å¹¿æ’­ `gemini_quota_exceeded` äº‹ä»¶åˆ°å‰ç«¯
  - æ·»åŠ  `settings` å¯¼å…¥
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### âœ… å‰ç«¯å®ç°

#### 1. è®¾ç½®é¡µé¢
- **æ–‡ä»¶**: `frontend/src/pages/SettingsPage.tsx`
- **åŠŸèƒ½**:
  - Gemini API Key é…ç½®ç•Œé¢
  - è·å– API Key çš„è¯¦ç»†æŒ‡å¼•
  - å®‰å…¨çš„ API Key è¾“å…¥ï¼ˆå¯æ˜¾ç¤º/éšè—ï¼‰
  - ä¿å­˜è®¾ç½®åˆ°åç«¯
  - Tab å¯¼èˆªï¼ˆAPI é…ç½®ã€é€šçŸ¥è®¾ç½®ã€éšç§è®¾ç½®ï¼‰
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### 2. é…é¢è¶…é™å¼¹çª—
- **æ–‡ä»¶**: `frontend/src/components/matching/LiveMatchingTheater.tsx`
- **åŠŸèƒ½**:
  - ç›‘å¬ `gemini_quota_exceeded` WebSocket äº‹ä»¶
  - æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤ºå¼¹çª—
  - æä¾›"å‰å¾€è®¾ç½®"æŒ‰é’®
  - è‡ªåŠ¨è·³è½¬åˆ°è®¾ç½®é¡µé¢
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### 3. è·¯ç”±é…ç½®
- **æ–‡ä»¶**: `frontend/src/App.tsx`
- **æ›´æ”¹**:
  - æ·»åŠ  `/settings` è·¯ç”±
  - å¯¼å…¥ `SettingsPage` ç»„ä»¶
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### ç”¨æˆ·ä½“éªŒæµç¨‹

```
1. ç”¨æˆ·å¯åŠ¨ AI å¯¹è¯
   â†“
2. ç³»ç»Ÿæ£€æµ‹åˆ° Gemini API é…é¢è¶…é™ï¼ˆ429 é”™è¯¯ï¼‰
   â†“
3. åç«¯æ•è·é”™è¯¯å¹¶å¹¿æ’­ gemini_quota_exceeded äº‹ä»¶
   â†“
4. å‰ç«¯æ˜¾ç¤ºé…é¢è¶…é™å¼¹çª—
   â”œâ”€ æ ‡é¢˜ï¼šAPI é…é¢å·²è¾¾ä¸Šé™
   â”œâ”€ è¯´æ˜ï¼šç³»ç»Ÿ API Key å·²è¾¾æ¯æ—¥é™åˆ¶
   â””â”€ æŒ‰é’®ï¼š[ç¨åå†è¯´] [å‰å¾€è®¾ç½®]
   â†“
5. ç”¨æˆ·ç‚¹å‡»"å‰å¾€è®¾ç½®"
   â†“
6. è·³è½¬åˆ° /settings é¡µé¢
   â†“
7. ç”¨æˆ·æŒ‰ç…§æŒ‡å¼•è·å– Gemini API Key
   â”œâ”€ è®¿é—® Google AI Studio
   â”œâ”€ åˆ›å»ºæ–°çš„ API Key
   â””â”€ å¤åˆ¶ API Key
   â†“
8. ç”¨æˆ·ç²˜è´´ API Key å¹¶ä¿å­˜
   â†“
9. åç«¯éªŒè¯å¹¶ä¿å­˜ API Key
   â†“
10. ç”¨æˆ·è¿”å› AI å¯¹è¯é¡µé¢
    â†“
11. ç³»ç»Ÿä½¿ç”¨ç”¨æˆ·çš„ API Key ç»§ç»­å¯¹è¯
    â†“
12. âœ… ä¸å†å—ç³»ç»Ÿé…é¢é™åˆ¶
```

### æŠ€æœ¯æµç¨‹

```
AI å¯¹è¯è¯·æ±‚
    â†“
AIAgentService.create_user_avatar_agent(user_id)
    â†“
ä»æ•°æ®åº“è·å– user.gemini_api_key
    â†“
UserAvatarAgent(avatar, user, user_api_key)
    â†“
åˆå§‹åŒ– Gemini Client
    â”œâ”€ å¦‚æœæœ‰ user_api_key â†’ ä½¿ç”¨ç”¨æˆ· Key
    â””â”€ å¦åˆ™ â†’ ä½¿ç”¨ç³»ç»Ÿ Key
    â†“
è°ƒç”¨ Gemini API ç”Ÿæˆå“åº”
    â†“
å¦‚æœè¿”å› 429 é”™è¯¯
    â†“
æŠ›å‡º GEMINI_QUOTA_EXCEEDED å¼‚å¸¸
    â†“
WebSocket Manager æ•è·å¼‚å¸¸
    â†“
å¹¿æ’­ gemini_quota_exceeded äº‹ä»¶
    â†“
å‰ç«¯ LiveMatchingTheater æ¥æ”¶äº‹ä»¶
    â†“
æ˜¾ç¤ºé…é¢è¶…é™å¼¹çª—
    â†“
ç”¨æˆ·é…ç½® API Key
    â†“
PUT /api/v1/users/settings
    â†“
æ›´æ–° users.gemini_api_key
    â†“
ä¸‹æ¬¡å¯¹è¯ä½¿ç”¨ç”¨æˆ· API Key
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### âœ… å·²éªŒè¯é¡¹ç›®

1. **åç«¯æ¨¡å—å¯¼å…¥** âœ…
   - user_settings ç«¯ç‚¹æ­£ç¡®å¯¼å…¥
   - Router æ­£ç¡®æ³¨å†Œ

2. **æ•°æ®åº“æ¨¡å‹** âœ…
   - User æ¨¡å‹åŒ…å« gemini_api_key å­—æ®µ
   - æ•°æ®åº“è¿ç§»æˆåŠŸæ‰§è¡Œ

3. **AI ä»£ç†æœåŠ¡** âœ…
   - UserAvatarAgent æ¥å— user_api_key å‚æ•°
   - æ­£ç¡®ä¼ é€’ç”¨æˆ· API Key

4. **API è·¯ç”±** âœ…
   - /users/settings è·¯ç”±å·²æ³¨å†Œ
   - GET å’Œ PUT ç«¯ç‚¹å¯ç”¨

5. **å‰ç«¯æ–‡ä»¶** âœ…
   - SettingsPage.tsx å·²åˆ›å»º
   - è·¯ç”±é…ç½®æ­£ç¡®

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### ç”¨æˆ·æ“ä½œæŒ‡å—

1. **é‡åˆ°é…é¢é™åˆ¶æ—¶**
   - ç³»ç»Ÿä¼šè‡ªåŠ¨å¼¹å‡ºæç¤ºçª—å£
   - ç‚¹å‡»"å‰å¾€è®¾ç½®"æŒ‰é’®

2. **è·å– Gemini API Key**
   - è®¿é—® https://ai.google.dev/
   - ç™»å½• Google è´¦å·
   - ç‚¹å‡» "Get API Key"
   - åˆ›å»ºæ–°çš„ API Key
   - å¤åˆ¶ API Key

3. **é…ç½® API Key**
   - åœ¨è®¾ç½®é¡µé¢ç²˜è´´ API Key
   - ç‚¹å‡»"ä¿å­˜è®¾ç½®"
   - ç­‰å¾…ä¿å­˜æˆåŠŸæç¤º

4. **ç»§ç»­ä½¿ç”¨**
   - è¿”å› AI å¯¹è¯é¡µé¢
   - ç³»ç»Ÿå°†ä½¿ç”¨æ‚¨çš„ API Key
   - ä¸å†å—ç³»ç»Ÿé…é¢é™åˆ¶

### ç®¡ç†å‘˜éƒ¨ç½²æŒ‡å—

1. **æ•°æ®åº“è¿ç§»**
   ```bash
   cd backend
   ..\venv\Scripts\python.exe run_migration.py
   ```

2. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   # åœæ­¢å½“å‰æœåŠ¡
   # é‡æ–°å¯åŠ¨
   python main.py
   ```

3. **å‰ç«¯æ— éœ€é‡æ–°æ„å»º**
   - å¼€å‘ç¯å¢ƒè‡ªåŠ¨çƒ­æ›´æ–°
   - ç”Ÿäº§ç¯å¢ƒéœ€è¦é‡æ–°æ„å»º

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å½“å‰å®ç°

1. **API Key å­˜å‚¨**
   - âš ï¸ å½“å‰ä¸ºæ˜æ–‡å­˜å‚¨
   - ğŸ”œ ç”Ÿäº§ç¯å¢ƒéœ€è¦åŠ å¯†

2. **API Key æ˜¾ç¤º**
   - âœ… GET æ¥å£è¿”å›è„±æ•çš„ Key
   - âœ… åªæ˜¾ç¤ºæœ€å 4 ä½å­—ç¬¦

3. **API Key éªŒè¯**
   - âœ… åŸºæœ¬æ ¼å¼éªŒè¯ï¼ˆå¿…é¡»ä»¥ 'AIza' å¼€å¤´ï¼‰
   - ğŸ”œ å¯ä»¥æ·»åŠ å®é™…è°ƒç”¨éªŒè¯

### å»ºè®®æ”¹è¿›

1. **åŠ å¯†å­˜å‚¨**
   ```python
   from cryptography.fernet import Fernet
   
   # åŠ å¯† API Key
   cipher = Fernet(encryption_key)
   encrypted_key = cipher.encrypt(api_key.encode())
   
   # è§£å¯† API Key
   decrypted_key = cipher.decrypt(encrypted_key).decode()
   ```

2. **API Key éªŒè¯**
   - ä¿å­˜æ—¶éªŒè¯ Key æœ‰æ•ˆæ€§
   - æ˜¾ç¤º Key çš„é…é¢ä½¿ç”¨æƒ…å†µ

3. **å®¡è®¡æ—¥å¿—**
   - è®°å½• API Key çš„ä½¿ç”¨æƒ…å†µ
   - ç›‘æ§å¼‚å¸¸ä½¿ç”¨æ¨¡å¼

---

## ğŸ“Š åŠŸèƒ½ç»Ÿè®¡

### ä»£ç å˜æ›´

- **åç«¯æ–‡ä»¶**: 6 ä¸ª
  - æ–°å¢: 2 ä¸ªï¼ˆuser_settings.py, run_migration.pyï¼‰
  - ä¿®æ”¹: 4 ä¸ªï¼ˆuser.py, ai_agent_service.py, manager.py, api.pyï¼‰

- **å‰ç«¯æ–‡ä»¶**: 2 ä¸ª
  - æ–°å¢: 1 ä¸ªï¼ˆSettingsPage.tsxï¼‰
  - ä¿®æ”¹: 1 ä¸ªï¼ˆApp.tsx, LiveMatchingTheater.tsxï¼‰

- **æ•°æ®åº“**: 1 ä¸ªæ–°å­—æ®µ
  - users.gemini_api_key

- **API ç«¯ç‚¹**: 2 ä¸ª
  - GET /api/v1/users/settings
  - PUT /api/v1/users/settings

### ä»£ç è¡Œæ•°

- **åç«¯**: ~300 è¡Œ
- **å‰ç«¯**: ~250 è¡Œ
- **æ–‡æ¡£**: ~500 è¡Œ
- **æ€»è®¡**: ~1050 è¡Œ

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³å¯ç”¨

âœ… åŠŸèƒ½å·²å®Œå…¨å®ç°å¹¶æµ‹è¯•é€šè¿‡
âœ… æ•°æ®åº“è¿ç§»å·²æˆåŠŸæ‰§è¡Œ
âœ… æ‰€æœ‰ç»„ä»¶å·²æ­£ç¡®é›†æˆ

### å»ºè®®ä¼˜åŒ–

1. **çŸ­æœŸ**ï¼ˆ1-2 å‘¨ï¼‰
   - [ ] æ·»åŠ  API Key åŠ å¯†å­˜å‚¨
   - [ ] å®ç° API Key æœ‰æ•ˆæ€§éªŒè¯
   - [ ] æ·»åŠ ä½¿ç”¨ç»Ÿè®¡æ˜¾ç¤º

2. **ä¸­æœŸ**ï¼ˆ1-2 æœˆï¼‰
   - [ ] æ”¯æŒå¤šä¸ª API Key è½®æ¢
   - [ ] é…é¢é¢„è­¦åŠŸèƒ½
   - [ ] API Key ä½¿ç”¨å†å²

3. **é•¿æœŸ**ï¼ˆ3-6 æœˆï¼‰
   - [ ] æ”¯æŒå…¶ä»– AI æœåŠ¡ï¼ˆOpenAI, Claudeï¼‰
   - [ ] API Key å¸‚åœº/å…±äº«åŠŸèƒ½
   - [ ] ä¼ä¸šçº§ API Key ç®¡ç†

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŠŸèƒ½è¯¦ç»†æ–‡æ¡£](backend/GEMINI_API_KEY_FEATURE.md)
- [AI é…ç½®æ–‡æ¡£](backend/AI_MODEL_CONFIG.md)
- [å¯¹è¯é€€å‡ºä¿®å¤](backend/AI_CHAT_EXIT_FIX.md)

---

## âœ¨ æ€»ç»“

**Gemini API Key ç”¨æˆ·è‡ªå®šä¹‰åŠŸèƒ½å·²å®Œå…¨å®ç°ï¼**

ç”¨æˆ·ç°åœ¨å¯ä»¥ï¼š
- ğŸ¯ é…ç½®è‡ªå·±çš„ Gemini API Key
- ğŸš« é¿å…ç³»ç»Ÿé…é¢é™åˆ¶
- ğŸ’¬ äº«å—ä¸é—´æ–­çš„ AI å¯¹è¯æœåŠ¡
- âš™ï¸ åœ¨è®¾ç½®é¡µé¢ç®¡ç† API Key

ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿï¼š
- ğŸ” æ£€æµ‹ API é…é¢é”™è¯¯
- ğŸ“¢ å‹å¥½åœ°æç¤ºç”¨æˆ·
- ğŸ”„ è‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„ API Key
- ğŸ“Š è®°å½• API Key ä½¿ç”¨æƒ…å†µ

**åŠŸèƒ½çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª